<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - Disaster Management</title>

  <!-- Tailwind CSS for styling -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase SDK -->
  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getDatabase, ref, set, push, onValue, update, remove } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";
    import { getAuth, signOut } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAj6Oqcr0eRbJg4M0hK9inAOLSmtHyjAVI",
      authDomain: "dmse-9d4f8.firebaseapp.com",
      databaseURL: "https://dmse-9d4f8-default-rtdb.firebaseio.com",
      projectId: "dmse-9d4f8",
      storageBucket: "dmse-9d4f8.appspot.com",
      messagingSenderId: "219529746323",
      appId: "1:219529746323:web:9aed2195ad73640924ba66",
      measurementId: "G-BMQNH87EMJ"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    // CRUD Operations Functions
    function createRecord(path, data) {
      const recordRef = push(ref(db, path));
      set(recordRef, data)
        .then(() => {
          alert(`${path} record added successfully!`);
          closeModal('addModal');
        })
        .catch((error) => alert(`Error adding record: ${error.message}`));
    }

    function readRecords(path, callback) {
      const refPath = ref(db, path);
      onValue(refPath, (snapshot) => {
        const data = snapshot.val();
        callback(data);
      });
    }

    function updateRecord(path, id, data) {
      const recordRef = ref(db, `${path}/${id}`);
      update(recordRef, data)
        .then(() => {
          alert(`${path} record updated successfully!`);
          closeModal('editModal');
          loadCrudPage(path, `${path} Management`);
        })
        .catch((error) => alert(`Error updating record: ${error.message}`));
    }

    function deleteRecord(path, id) {
      if (confirm(`Are you sure you want to delete this ${path} record?`)) {
        const recordRef = ref(db, `${path}/${id}`);
        remove(recordRef)
          .then(() => {
            alert(`${path} record deleted successfully.`);
            loadCrudPage(path, `${path} Management`);
          })
          .catch((error) => alert(`Error deleting record: ${error.message}`));
      }
    }

    // Load Home Page with Cards
    function loadHomePage() {
      const contentArea = document.getElementById('contentArea');
      contentArea.innerHTML = `
        <h2 class="text-3xl font-semibold mb-4">Disaster Management System</h2>
        <div class="grid grid-cols-3 gap-6">
          ${generateHomePageCards()}
        </div>
      `;
    }

    function generateHomePageCards() {
      const entities = [
        { id: 'disasters', label: 'Disaster Management', image: 'https://via.placeholder.com/150' },
        { id: 'tasks', label: 'Task Management', image: 'https://via.placeholder.com/150' },
        { id: 'volunteers', label: 'Volunteer Management', image: 'https://via.placeholder.com/150' },
        { id: 'shelters', label: 'Shelter Management', image: 'https://via.placeholder.com/150' },
        { id: 'resources', label: 'Resource Management', image: 'https://via.placeholder.com/150' },
        { id: 'transportations', label: 'Transportation Management', image: 'https://via.placeholder.com/150' }
      ];

      return entities.map(entity => `
        <div class="bg-white p-4 shadow rounded-lg cursor-pointer" onclick="loadCrudPage('${entity.id}', '${entity.label}')">
          <img src="${entity.image}" alt="${entity.label}" class="w-full h-32 object-cover rounded-md mb-4">
          <h3 class="text-lg font-semibold">${entity.label}</h3>
        </div>
      `).join('');
    }

    // Load Form to Add New Records using Modal Popup
    function loadForm(entity, formTitle) {
      const modalContent = `
        <div class="fixed z-10 inset-0 overflow-y-auto" id="addModal">
          <div class="flex items-center justify-center min-h-screen">
            <div class="bg-white rounded-lg shadow-lg p-6 w-1/2">
              <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">${formTitle}</h3>
                <button class="text-gray-500 hover:text-gray-700" onclick="closeModal('addModal')">✖</button>
              </div>
              <form id="${entity}Form" class="space-y-4">
                <div id="dynamicFields"></div>
                <button type="submit" class="bg-orange-500 text-white px-4 py-2 rounded-md hover:bg-orange-600">Submit</button>
              </form>
            </div>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', modalContent);

      // Define form fields based on entity type
      const formFields = {
        disasters: [
          { id: "name", label: "Name", type: "text" },
          { id: "date", label: "Date", type: "date" },
          { id: "severity", label: "Severity", type: "dropdown", options: ["Low", "Moderate", "High"] }
        ],
        tasks: [
          { id: "name", label: "Task Name", type: "text" },
          { id: "assignedTo", label: "Assigned To", type: "text" },
          { id: "status", label: "Status", type: "dropdown", options: ["Pending", "In Progress", "Completed"] }
        ],
        volunteers: [
          { id: "name", label: "Volunteer Name", type: "text" },
          { id: "contact", label: "Contact Number", type: "text" },
          { id: "assignedDisaster", label: "Assigned Disaster", type: "text" }
        ],
        transportations: [
          { id: "capacity", label: "Capacity", type: "number" },
          { id: "disasterId", label: "Disaster ID", type: "number" },
          { id: "location", label: "Location", type: "text" },
          { id: "vehicleType", label: "Vehicle Type", type: "text" }
        ]
      };

      const entityFields = formFields[entity];
      const dynamicFields = document.getElementById('dynamicFields');

      entityFields.forEach(field => {
        if (field.type === "dropdown") {
          dynamicFields.innerHTML += `
            <div class="mb-4">
              <label for="${field.id}" class="block text-sm font-medium">${field.label}</label>
              <select id="${field.id}" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                ${field.options.map(option => `<option value="${option}">${option}</option>`).join('')}
              </select>
            </div>
          `;
        } else {
          dynamicFields.innerHTML += `
            <div class="mb-4">
              <label for="${field.id}" class="block text-sm font-medium">${field.label}</label>
              <input type="${field.type}" id="${field.id}" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
            </div>
          `;
        }
      });

      document.getElementById(`${entity}Form`).addEventListener('submit', (e) => {
        e.preventDefault();
        const data = {};
        dynamicFields.querySelectorAll('input, select').forEach(field => {
          data[field.id] = field.value;
        });

        createRecord(entity, data);
      });
    }

    function closeModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.remove();
      }
    }

    // Load CRUD Page
    function loadCrudPage(entity, title) {
      const contentArea = document.getElementById('contentArea');
      contentArea.innerHTML = `
        <h2 class="text-3xl font-semibold mb-4">${title}</h2>
        <button class="bg-green-500 text-white px-4 py-2 rounded mb-4" onclick="loadForm('${entity}', 'Add ${title}')">Add ${title}</button>
        <div class="bg-white p-4 shadow rounded-lg mt-6">
          <table class="min-w-full bg-white">
            <thead>
              <tr id="${entity}TableHeaders"></tr>
            </thead>
            <tbody id="${entity}TableBody"></tbody>
          </table>
        </div>
      `;

      // Use the correct Firebase path
      readRecords(entity === 'transportations' ? 'transportation' : entity, (data) => {
        const tableHeaders = document.getElementById(`${entity}TableHeaders`);
        const tableBody = document.getElementById(`${entity}TableBody`);
        tableBody.innerHTML = '';

        if (data) {
          let firstRecord = true;

          Object.keys(data).forEach(id => {
            const record = data[id];

            if (firstRecord) {
              // Create headers dynamically
              tableHeaders.innerHTML = `
                <th class="px-6 py-3 border-b-2 border-gray-300 text-left text-sm font-semibold text-gray-700">ID</th>
                ${Object.keys(record).map(field => `<th class="px-6 py-3 border-b-2 border-gray-300 text-left text-sm font-semibold text-gray-700">${field}</th>`).join('')}
                <th class="px-6 py-3 border-b-2 border-gray-300 text-left text-sm font-semibold text-gray-700">Actions</th>
              `;
              firstRecord = false;
            }

            tableBody.innerHTML += `
              <tr>
                <td class="px-6 py-2">${id}</td>
                ${Object.values(record).map(value => `<td class="px-6 py-2">${value}</td>`).join('')}
                <td class="px-6 py-2">
                  <button class="bg-yellow-500 text-white px-3 py-1 rounded mr-2" onclick="loadEditForm('${entity}', '${id}', ${JSON.stringify(record)})">Edit</button>
                  <button class="bg-red-500 text-white px-3 py-1 rounded" onclick="deleteRecord('${entity}', '${id}')">Delete</button>
                </td>
              </tr>
            `;
          });
        }
      });
    }

    // Edit Record using Modal Popup
    function loadEditForm(entity, id, record) {
      const editModal = `
        <div class="fixed z-10 inset-0 overflow-y-auto" id="editModal">
          <div class="flex items-center justify-center min-h-screen">
            <div class="bg-white rounded-lg shadow-lg p-6 w-1/2">
              <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">Edit ${entity}</h3>
                <button class="text-gray-500 hover:text-gray-700" onclick="closeModal('editModal')">✖</button>
              </div>
              <form id="editForm" class="space-y-4">
                <div id="editDynamicFields"></div>
                <button type="submit" class="bg-orange-500 text-white px-4 py-2 rounded-md hover:bg-orange-600">Update</button>
              </form>
            </div>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', editModal);

      const editDynamicFields = document.getElementById('editDynamicFields');

      Object.keys(record).forEach(key => {
        if (key !== 'id') {
          editDynamicFields.innerHTML += `
            <div class="mb-4">
              <label for="edit_${key}" class="block text-sm font-medium">${key}</label>
              <input type="text" id="edit_${key}" value="${record[key]}" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
            </div>
          `;
        }
      });

      document.getElementById('editForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const updatedData = {};
        Object.keys(record).forEach(key => {
          if (key !== 'id') {
            updatedData[key] = document.getElementById(`edit_${key}`).value;
          }
        });
        updateRecord(entity, id, updatedData);
      });
    }

    // Logout Function
    function logout() {
      signOut(auth)
        .then(() => {
          alert('Logged out successfully.');
          window.location.href = "login.html"; // Replace with the actual login page
        })
        .catch((error) => alert(`Error logging out: ${error.message}`));
    }

    // Make the functions globally accessible
    window.loadHomePage = loadHomePage;
    window.loadForm = loadForm;
    window.loadCrudPage = loadCrudPage;
    window.deleteRecord = deleteRecord;
    window.loadEditForm = loadEditForm;
    window.closeModal = closeModal;
    window.logout = logout;

    // Load home page initially
    document.addEventListener("DOMContentLoaded", loadHomePage);
  </script>
</head>

<body class="bg-gray-100">

  <!-- Navigation Sidebar -->
  <div class="flex">
    <div class="w-1/5 bg-gray-200 p-6">
      <h2 class="text-center text-2xl font-semibold mb-6">DMS</h2>
      <a href="#" onclick="loadHomePage()" class="block py-2 px-4 bg-orange-500 text-white rounded-md mb-4 text-center">Home</a>
      <a href="#" onclick="loadCrudPage('disasters', 'Disaster Management')" class="block py-2 px-4 text-gray-700 hover:bg-gray-300 rounded-md mb-4 text-center">Disaster Management</a>
      <a href="#" onclick="loadCrudPage('tasks', 'Task Management')" class="block py-2 px-4 text-gray-700 hover:bg-gray-300 rounded-md mb-4 text-center">Task Management</a>
      <a href="#" onclick="loadCrudPage('volunteers', 'Volunteer Management')" class="block py-2 px-4 text-gray-700 hover:bg-gray-300 rounded-md mb-4 text-center">Volunteer Management</a>
      <a href="#" onclick="loadCrudPage('shelters', 'Shelter Management')" class="block py-2 px-4 text-gray-700 hover:bg-gray-300 rounded-md mb-4 text-center">Shelter Management</a>
      <a href="#" onclick="loadCrudPage('resources', 'Resource Management')" class="block py-2 px-4 text-gray-700 hover:bg-gray-300 rounded-md mb-4 text-center">Resource Management</a>
      <a href="#" onclick="loadCrudPage('transportations', 'Transportation Management')" class="block py-2 px-4 text-gray-700 hover:bg-gray-300 rounded-md mb-4 text-center">Transportation Management</a>
      <button onclick="logout()" class="block w-full py-2 px-4 bg-red-500 text-white rounded-md mt-6 text-center">Logout</button>
    </div>

    <!-- Main Content Area -->
    <div class="w-4/5 p-6" id="contentArea">
      <!-- Content will be dynamically loaded here -->
    </div>
  </div>

</body>

</html>
